You are implementing Phase 1 – Feature F1-10 for the AlphaLens app.

Feature ID: F1-10
Title: Auth-Analyze Integration (End-to-End Flow)

--------------------------------------------------
Problem Statement:
--------------------------------------------------
- OAuth authentication (F1-1) exists but is not integrated with the analyze API.
- Users can run analysis without being signed in.
- Run outputs are not attributed to any user.

--------------------------------------------------
Goal (F1-10):
--------------------------------------------------
Connect authentication to the analyze flow end-to-end:
1) Require signed-in user to run stock analysis
2) Frontend sends auth token (JWT) to backend on analyze requests
3) Backend verifies token and extracts user_id (Cognito sub)
4) All run outputs are attributed to user_id

--------------------------------------------------
Governance Rules (MANDATORY):
--------------------------------------------------
- Implement ONLY F1-10. Do not start any other feature.
- Update docs/feature-index.md:
  - Set F1-10 → In Progress at start
  - Set F1-10 → Complete ONLY after tests pass
- Follow Base PRD and Phase-1 PRD strictly.

--------------------------------------------------
Architecture Constraints:
--------------------------------------------------
- Follow Clean Architecture (Ports & Adapters).
- Use existing AuthVerifier interface from F1-1.
- Create RunRepository interface with in-memory implementation.
- Database persistence is OUT OF SCOPE (prepare interface only).
- Secrets MUST NOT be committed.

--------------------------------------------------
Backend Requirements:
--------------------------------------------------
1) Token Verification Middleware
   - Verify JWT on protected endpoints (/recommendations/*)
   - Extract user_id (sub) from token claims
   - Return 401 Unauthorized if token invalid/missing
   - Inject authenticated user into request context

2) Analyze Endpoint Updates
   - Require authenticated user
   - Pass user_id to recommendation service
   - Attribute run results to user_id

3) RunRepository Interface
   - Define abstract interface for run storage
   - Methods: save(run), get_by_id(run_id), get_by_user(user_id)
   - Create InMemoryRunRepository implementation
   - Prepare for future database implementation

4) User Context
   - Create AuthenticatedUser model with:
     - sub (user_id)
     - email
     - plan (free/pro)
     - roles (user/admin)

--------------------------------------------------
Frontend Requirements:
--------------------------------------------------
1) API Client Updates
   - Include Authorization header on analyze requests
   - Format: Bearer <access_token>
   - Handle 401 responses (redirect to login)

2) Protected Routes
   - /analyze page requires authentication
   - /results/[runId] page requires authentication
   - /history page requires authentication
   - Redirect unauthenticated users to /login

3) Auth State Integration
   - Use existing auth context from F1-1
   - Pass token to API calls
   - Handle token refresh if needed

--------------------------------------------------
Environment Variables:
--------------------------------------------------
Existing (from F1-1):
AUTH_MODE=cognito|mock
COGNITO_USER_POOL_ID=...
COGNITO_CLIENT_ID=...
COGNITO_ISSUER=...

New (if needed):
AUTH_REQUIRED=true|false  # Allow bypassing auth in dev

--------------------------------------------------
Test Requirements:
--------------------------------------------------
1) Backend Tests
   - Token verification middleware (valid/invalid/missing token)
   - Protected endpoint access (authenticated vs unauthenticated)
   - User context extraction from token
   - RunRepository interface implementation

2) Frontend Tests
   - Auth header included in API calls
   - 401 handling and redirect
   - Protected route behavior

--------------------------------------------------
Deliverables:
--------------------------------------------------
1) Token verification middleware
2) Protected endpoint decorators/dependencies
3) RunRepository interface + in-memory implementation
4) Frontend auth header integration
5) Protected route guards
6) Unit tests for auth flow
7) Feature docs:
   - spec.md
   - tasks.md
   - tests.md
   - acceptance.md
   - rollback.md

--------------------------------------------------
Acceptance Criteria:
--------------------------------------------------
- Unauthenticated users cannot access /recommendations/analyze
- Authenticated users can run analysis successfully
- Run results contain user_id from token
- 401 returned for invalid/missing tokens
- Frontend redirects to login on 401
- RunRepository interface is defined (in-memory impl works)
- All tests pass
- Feature index updated correctly

--------------------------------------------------
Out of Scope:
--------------------------------------------------
- Database persistence (interface only)
- Usage limit enforcement (F1-3)
- Admin role checks (F1-6)
- Token refresh logic (use existing F1-1 implementation)

Now implement Feature F1-10 ONLY.
